# .github/workflows/release.yml

name: Build, Push to GHCR & Upload to Release

on:
  release:
    types: [published] # æ¯å½“åœ¨ GitHub ä¸Šå‘å¸ƒä¸€ä¸ªæ–°çš„ Release æ—¶è§¦å‘

# ä¸ºå·¥ä½œæµè®¾ç½®æƒé™ï¼Œå…è®¸å…¶æ¨é€åˆ° GHCR å’Œä¸Šä¼ æ–‡ä»¶åˆ° Release
permissions:
  contents: write      # å…è®¸ä¸Šä¼ æ–‡ä»¶åˆ° Release
  packages: write      # å…è®¸æ¨é€åˆ° GitHub Container Registry (GHCR)

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ§¾ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ”‘ Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¦ Extract version and define image names
        id: prep
        run: |
          # ä» Release æ ‡ç­¾ (å¦‚ v1.2.3) ä¸­æå–çº¯ç‰ˆæœ¬å· (1.2.3)
          # è¿™æ˜¯ä¸ºäº†ä¼ é€’ç»™ Dockerfile ä¸­çš„ SINGBOX_VERSION å‚æ•°
          VERSION_NUM=${{ github.ref_name }}
          VERSION_NUM=${VERSION_NUM#v}
          
          # å®šä¹‰é•œåƒåç§°å’Œæ ‡ç­¾
          IMAGE_NAME="ghcr.io/${{ github.repository_owner }}/singbox-wgcf-proxy"
          TAR_NAME="singbox-wgcf-proxy-arm64-${{ github.ref_name }}.tar"

          # å°†å˜é‡è¾“å‡ºï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "VERSION_NUM=${VERSION_NUM}" >> $GITHUB_ENV
          echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
          echo "TAR_NAME=${TAR_NAME}" >> $GITHUB_ENV
          echo "IMAGE_TAGS=${IMAGE_NAME}:latest,${IMAGE_NAME}:${{ github.ref_name }}" >> $GITHUB_ENV
          
      - name: ğŸ› ï¸ Build, Push to GHCR, and Save as Tarball
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile  # ç¡®ä¿è¿™é‡ŒæŒ‡å‘æ­£ç¡®çš„ Dockerfile æ–‡ä»¶å
          platforms: linux/arm64
          push: true
          tags: ${{ env.IMAGE_TAGS }}
          # å…³é”®ä¸€æ­¥ï¼šå°† Release ç‰ˆæœ¬å·ä½œä¸ºæ„å»ºå‚æ•°ä¼ é€’ç»™ Dockerfile
          build-args: |
            SINGBOX_VERSION=${{ env.VERSION_NUM }}
          # ä¼˜åŒ–ï¼šåŒæ—¶å°†æ„å»ºç»“æœå¯¼å‡ºä¸º .tar æ–‡ä»¶ï¼Œé¿å…äºŒæ¬¡æ„å»º
          outputs: type=docker,dest=${{ env.TAR_NAME }}

      - name: â¬†ï¸ Upload Tarball to GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          # ä¸Šä¼ æˆ‘ä»¬åˆšåˆšå¯¼å‡ºçš„ .tar æ–‡ä»¶
          files: ${{ env.TAR_NAME }}
